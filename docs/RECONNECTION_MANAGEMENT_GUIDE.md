# μ¬μ—°κ²° κ΄€λ¦¬ λ΅μ§ κ°€μ΄λ“

μ΄ λ¬Έμ„λ” κ²μ„ λ΅λΉ„ μ‹μ¤ν…μ μ¬μ—°κ²° κ΄€λ¦¬ λ΅μ§μ„ λ‹΄λ‹Ήν•λ” κ° νμΌλ“¤μ μ—­ν• κ³Ό μ£Όμ” ν•¨μλ“¤μ„ μ •λ¦¬ν•©λ‹λ‹¤.

## π“ νμΌ κµ¬μ΅° λ° μ—­ν• 

### 1. μ„λ²„ μΈ΅ μ¬μ—°κ²° κ΄€λ¦¬

#### `server/routes.ts`
**μ—­ν• **: WebSocket μ—°κ²° κ΄€λ¦¬ λ° μ¬μ—°κ²° κ°μ§€ μ²λ¦¬

**μ£Όμ” ν•¨μλ“¤**:
- `handleWebSocketMessage()`: WebSocket λ©”μ‹μ§€ μ²λ¦¬
  - `associate_user` μΌ€μ΄μ¤: μ‚¬μ©μ μ—°κ²° μ‹ μ¬μ—°κ²° κ°μ§€
  - κ²μ„ μ¤‘μΈ λ°©μ—μ„ μ—°κ²° ν•΄μ λ ν”λ μ΄μ–΄ μ¬μ—°κ²° μ²λ¦¬
- `handleUserDisconnect()`: μ‚¬μ©μ μ—°κ²° ν•΄μ  μ²λ¦¬
  - κ²μ„ μ§„ν–‰ μ¤‘μΈ κ²½μ° κ²μ„ ν•Έλ“¤λ¬μ— μ—°κ²° ν•΄μ  μ•λ¦Ό
- `broadcastToRoom()`: λ°© λ‚΄ λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ—κ² λ©”μ‹μ§€ λΈλ΅λ“μΊμ¤νΈ

**μ¬μ—°κ²° μ²λ¦¬ νλ¦„**:
1. ν΄λΌμ΄μ–ΈνΈκ°€ `associate_user` λ©”μ‹μ§€ μ „μ†΅
2. μ„λ²„μ—μ„ ν•΄λ‹Ή μ‚¬μ©μκ°€ κ²μ„ μ¤‘μΈ λ°©μ— μλ”μ§€ ν™•μΈ
3. μ—°κ²° ν•΄μ λ μƒνƒλΌλ©΄ κ²μ„ ν•Έλ“¤λ¬μ `handlePlayerReconnect` νΈμ¶
4. λ°© μƒνƒ μ—…λ°μ΄νΈ λΈλ΅λ“μΊμ¤νΈ

#### `shared/games/base/handlers/base-game-handler.ts`
**μ—­ν• **: λ¨λ“  κ²μ„μ κ³µν†µ μ¬μ—°κ²° κ΄€λ¦¬ λ΅μ§

**μ£Όμ” ν•¨μλ“¤**:
- `handlePlayerDisconnect(roomId, playerId)`: ν”λ μ΄μ–΄ μ—°κ²° ν•΄μ  μ²λ¦¬
  - κ²μ„ μƒνƒ μ ν¨μ„± κ²€μ‚¬
  - `disconnectedPlayers` λ°°μ—΄μ— ν”λ μ΄μ–΄ μ¶”κ°€
  - κ²μ„λ³„ νΉμ μ²λ¦¬ (`onPlayerDisconnect`) νΈμ¶
  - ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μƒνƒ μ—…λ°μ΄νΈ λΈλ΅λ“μΊμ¤νΈ

- `handlePlayerReconnect(roomId, playerId)`: ν”λ μ΄μ–΄ μ¬μ—°κ²° μ²λ¦¬
  - κ²μ„ μƒνƒ μ ν¨μ„± κ²€μ‚¬
  - `disconnectedPlayers` λ°°μ—΄μ—μ„ ν”λ μ΄μ–΄ μ κ±°
  - κ²μ„λ³„ νΉμ μ²λ¦¬ (`onPlayerReconnect`) νΈμ¶
  - ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μƒνƒ μ—…λ°μ΄νΈ λΈλ΅λ“μΊμ¤νΈ

- `onPlayerDisconnect()`: κ²μ„λ³„ μ—°κ²° ν•΄μ  μ²λ¦¬ (μ¤λ²„λΌμ΄λ“ κ°€λ¥)
- `onPlayerReconnect()`: κ²μ„λ³„ μ¬μ—°κ²° μ²λ¦¬ (μ¤λ²„λΌμ΄λ“ κ°€λ¥)

**μƒνƒ κ΄€λ¦¬**:
- `disconnectedPlayers`: μ—°κ²° ν•΄μ λ ν”λ μ΄μ–΄ ID λ°°μ—΄
- `lastUpdated`: λ§μ§€λ§‰ μ—…λ°μ΄νΈ μ‹κ°„

### 2. ν΄λΌμ΄μ–ΈνΈ μΈ΅ μ¬μ—°κ²° κ΄€λ¦¬

#### `client/src/hooks/use-websocket.tsx`
**μ—­ν• **: WebSocket μ—°κ²° κ΄€λ¦¬ λ° μλ™ μ¬μ—°κ²°

**μ£Όμ” ν•¨μλ“¤**:
- `useWebSocket()`: WebSocket ν›…
  - μλ™ μ¬μ—°κ²° λ΅μ§
  - μ—°κ²° μƒνƒ κ΄€λ¦¬
  - λ©”μ‹μ§€ μ „μ†΅/μμ‹ 

**μ¬μ—°κ²° μ„¤μ •**:
- `reconnect`: μ¬μ—°κ²° ν™μ„±ν™”/λΉ„ν™μ„±ν™” (κΈ°λ³Έ: true)
- `reconnectInterval`: μ¬μ—°κ²° κ°„κ²© (κΈ°λ³Έ: 3000ms)
- `maxReconnectAttempts`: μµλ€ μ¬μ—°κ²° μ‹λ„ νμ (κΈ°λ³Έ: 5ν)

**μ£Όμ” κΈ°λ¥**:
- μ—°κ²° ν•΄μ  μ‹ μλ™ μ¬μ—°κ²° μ‹λ„
- μ •μƒ μΆ…λ£(μ½”λ“ 1000) μ‹μ—λ” μ¬μ—°κ²°ν•μ§€ μ•μ
- μ¬μ—°κ²° μ‹λ„ νμ μ ν•
- μ—°κ²° μƒνƒ μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ

#### `client/src/pages/game-play.tsx`
**μ—­ν• **: κ²μ„ νμ΄μ§€μ—μ„μ μ¬μ—°κ²° μ²λ¦¬

**μ£Όμ” ν•¨μλ“¤**:
- WebSocket λ©”μ‹μ§€ ν•Έλ“¤λ¬:
  - `game_state`: κ²μ„ μƒνƒ μ—…λ°μ΄νΈ
  - `game_update`: κ²μ„ μƒνƒ μ—…λ°μ΄νΈ
  - `player_left`: ν”λ μ΄μ–΄ λ‚κ°€κΈ° μ²λ¦¬
  - `player_reconnected`: ν”λ μ΄μ–΄ μ¬μ—°κ²° μ²λ¦¬

- `onOpen` μ½λ°±:
  - μ‚¬μ©μ μ—°κ²° μ‹ `associate_user` λ©”μ‹μ§€ μ „μ†΅
  - μ¬μ—°κ²° μ‹ λ°© μ •λ³΄ μ—…λ°μ΄νΈ μ”μ²­

**μ¬μ—°κ²° μ²λ¦¬**:
- νμ΄μ§€ λ΅λ“ μ‹ μ‚¬μ©μ μ—°κ²° ν™•μΈ
- κ²μ„ μƒνƒ μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ
- μ—°κ²° ν•΄μ λ ν”λ μ΄μ–΄ μƒνƒ ν‘μ‹

## π”„ μ¬μ—°κ²° μ²λ¦¬ νλ¦„

### 1. μ—°κ²° ν•΄μ  μ‹
```
ν΄λΌμ΄μ–ΈνΈ μ—°κ²° ν•΄μ 
    β†“
μ„λ²„μ—μ„ handleUserDisconnect νΈμ¶
    β†“
κ²μ„ ν•Έλ“¤λ¬μ handlePlayerDisconnect νΈμ¶
    β†“
disconnectedPlayers λ°°μ—΄μ— ν”λ μ΄μ–΄ μ¶”κ°€
    β†“
ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μƒνƒ μ—…λ°μ΄νΈ λΈλ΅λ“μΊμ¤νΈ
```

### 2. μ¬μ—°κ²° μ‹
```
ν΄λΌμ΄μ–ΈνΈ μ¬μ—°κ²°
    β†“
associate_user λ©”μ‹μ§€ μ „μ†΅
    β†“
μ„λ²„μ—μ„ μ¬μ—°κ²° κ°μ§€
    β†“
κ²μ„ ν•Έλ“¤λ¬μ handlePlayerReconnect νΈμ¶
    β†“
disconnectedPlayers λ°°μ—΄μ—μ„ ν”λ μ΄μ–΄ μ κ±°
    β†“
ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μƒνƒ μ—…λ°μ΄νΈ λΈλ΅λ“μΊμ¤νΈ
```

## π® κ²μ„λ³„ νΉμ μ²λ¦¬

κ° κ²μ„μ€ `BaseGameHandler`λ¥Ό μƒμ†λ°›μ•„ λ‹¤μ λ©”μ„λ“λ“¤μ„ μ¤λ²„λΌμ΄λ“ν•  μ μμµλ‹λ‹¤:

- `onPlayerDisconnect()`: κ²μ„λ³„ μ—°κ²° ν•΄μ  μ²λ¦¬
- `onPlayerReconnect()`: κ²μ„λ³„ μ¬μ—°κ²° μ²λ¦¬

μμ‹:
```typescript
// ν‹±νƒν†  κ²μ„μ κ²½μ°
protected async onPlayerReconnect(gameState: TicTacToeGameState, playerId: string): Promise<void> {
  // μ¬μ—°κ²°λ ν”λ μ΄μ–΄μ ν„΄ λ³µμ› λ΅μ§
  if (gameState.currentPlayer === playerId) {
    // ν„΄ λ³µμ› μ²λ¦¬
  }
}
```

## π“ μƒνƒ κ΄€λ¦¬

### μ„λ²„ μΈ΅ μƒνƒ
- `disconnectedPlayers`: μ—°κ²° ν•΄μ λ ν”λ μ΄μ–΄ ID λ°°μ—΄
- `lastUpdated`: λ§μ§€λ§‰ μ—…λ°μ΄νΈ μ‹κ°„
- `gameState`: μ „μ²΄ κ²μ„ μƒνƒ

### ν΄λΌμ΄μ–ΈνΈ μΈ΅ μƒνƒ
- `isConnected`: WebSocket μ—°κ²° μƒνƒ
- `reconnectAttempts`: μ¬μ—°κ²° μ‹λ„ νμ
- `gameState`: ν„μ¬ κ²μ„ μƒνƒ

## π”§ μ„¤μ • μµμ…

### WebSocket μ¬μ—°κ²° μ„¤μ •
```typescript
const { sendMessage, isConnected } = useWebSocket('/ws', {
  reconnect: true,              // μ¬μ—°κ²° ν™μ„±ν™”
  reconnectInterval: 3000,      // μ¬μ—°κ²° κ°„κ²© (ms)
  maxReconnectAttempts: 5,      // μµλ€ μ¬μ—°κ²° μ‹λ„ νμ
  onMessage: handleMessage,     // λ©”μ‹μ§€ μ²λ¦¬ ν•¨μ
  onOpen: handleOpen,          // μ—°κ²° μ„±κ³µ μ‹ μ²λ¦¬
  onClose: handleClose,        // μ—°κ²° ν•΄μ  μ‹ μ²λ¦¬
  onError: handleError         // μ¤λ¥ μ‹ μ²λ¦¬
});
```

## π¨ μ£Όμμ‚¬ν•­

1. **κ²μ„ μƒνƒ μΌκ΄€μ„±**: μ¬μ—°κ²° μ‹ κ²μ„ μƒνƒκ°€ μ¬λ°”λ¥΄κ² λ³µμ›λλ”μ§€ ν™•μΈ
2. **μ¤‘λ³µ μ²λ¦¬ λ°©μ§€**: κ°™μ€ ν”λ μ΄μ–΄μ μ¤‘λ³µ μ¬μ—°κ²° μ²λ¦¬ λ°©μ§€
3. **νƒ€μ„μ•„μ›ƒ μ²λ¦¬**: μ¬μ—°κ²° μ‹λ„ νμ μ ν•μΌλ΅ λ¬΄ν• λ£¨ν”„ λ°©μ§€
4. **λ©”λ¨λ¦¬ λ„μ λ°©μ§€**: WebSocket μ—°κ²° μ •λ¦¬ λ° μ΄λ²¤νΈ λ¦¬μ¤λ„ μ κ±°

## π“ λ΅κ·Έ ν™•μΈ

μ¬μ—°κ²° μ²λ¦¬ κ³Όμ •μ€ μƒμ„Έν• λ΅κ·Έλ¥Ό ν†µν•΄ μ¶”μ ν•  μ μμµλ‹λ‹¤:

- `π”`: μ¬μ—°κ²° κ°μ§€ λ° μ²λ¦¬ μ‹μ‘
- `β…`: μ„±κ³µμ μΈ μ²λ¦¬ μ™„λ£
- `β`: μ¤λ¥ λ°μƒ
- `β οΈ`: μ£Όμμ‚¬ν•­ (μ¤‘λ³µ μ²λ¦¬ λ“±)
- `π“Ά`: λΈλ΅λ“μΊμ¤νΈ μ „μ†΅
- `π”„`: μ¬μ—°κ²° μ‹λ„

μ΄ κµ¬μ΅°λ¥Ό ν†µν•΄ κ²μ„ μ¤‘ λ„¤νΈμ›ν¬ μ—°κ²°μ΄ λμ–΄μ Έλ„ ν”λ μ΄μ–΄κ°€ μ•μ „ν•κ² μ¬μ—°κ²°ν•  μ μμΌλ©°, κ²μ„ μƒνƒκ°€ μ¬λ°”λ¥΄κ² λ³µμ›λ©λ‹λ‹¤.
